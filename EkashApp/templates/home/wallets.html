{% extends '../layouts/layout.html' %}

{% block script %}
            <script src="/static/vendor/chartjs/chartjs.js"></script>
            <script src="/static/js/plugins/chartjs-line-balance-overtime.js"></script>
            {{ chart_labels|json_script:"wallet_chart_labels" }}
            {{ chart_data|json_script:"wallet_chart_data" }}

            <script>
                (function(){
                    try{
                        const labels = JSON.parse(document.getElementById('wallet_chart_labels').textContent || '[]');
                        const data = JSON.parse(document.getElementById('wallet_chart_data').textContent || '[]');
                        const ctx = document.getElementById('chartjsBalanceOvertime');
                        if(ctx && window.Chart){
                            const chart = new Chart(ctx.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Balance',
                                        data: data,
                                        borderColor: '#6f42c1',
                                        backgroundColor: 'rgba(111,66,193,0.08)',
                                        fill: true,
                                        tension: 0.3,
                                    }]
                                },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        }
                    }catch(e){
                        console.error('Chart init error', e);
                    }
                })();
            </script>
{% endblock %} 

{% block content %}

    <div class="content-body">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="page-title">
                        <div class="row align-items-center justify-content-between">
                            <div class="col-xl-4">
                                <div class="page-title-content">
                                    <h3>Wallets</h3>
                                    <p class="mb-2">Welcome Ekash Finance Management</p>
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="breadcrumbs"><a href="#">Home </a>
                                    <span><i class="fi fi-rr-angle-small-right"></i></span>
                                    <a href="#">Wallets</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                    <div class="wallet-tab">
                <div class="row g-0">
                    <div class="col-xl-3">
                        <div class="nav d-block">
                            <div class="row">
                                {% for wallet in wallets %}
                                <div class="col-xl-12 col-md-6">
                                    <a href="?wallet={{ wallet.pk }}" class="wallet-nav {% if selected_wallet and wallet.pk==selected_wallet.pk %}active{% endif %}">
                                        <div class="wallet-nav-icon">
                                            <span><i class="fi fi-rr-bank"></i></span>
                                        </div>
                                        <div class="wallet-nav-text">
                                            <h3>{{ wallet.name }}</h3>
                                            <p>${{ wallet.balance }}</p>
                                        </div>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="add-card-link">
                            <h5 class="mb-0">Add new wallet</h5>
                            <a href="{% url 'wallet_add' %}">
                                <i class="fi fi-rr-square-plus"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-xl-9">
                        <div class="tab-content wallet-tab-content">
                            <div class="tab-pane show active">
                                <div class="wallet-tab-title">
                                    <h3>{{ selected_wallet.name if selected_wallet else 'No Wallet Selected' }}</h3>
                                </div>
                                <div class="row">
                                    <div class="col-xxl-6 col-xl-6 col-lg-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="wallet-total-balance">
                                                    <p class="mb-0">Total Balance</p>
                                                    <h2>${{ total_balance }}</h2>
                                                </div>
                                                <div class="funds-credit">
                                                    <p class="mb-0">Personal Funds</p>
                                                    <h5>${{ personal_funds }}</h5>
                                                </div>
                                                <div class="funds-credit">
                                                    <p class="mb-0">Credit Limits</p>
                                                    <h5>${{ credit_limits }}</h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xxl-6 col-xl-6 col-lg-6">
                                        <div class="credit-card visa">
                                            <div class="type-brand">
                                                <h4>Debit Card</h4>
                                                <img src="/static/images/cc/visa.png" alt="">
                                            </div>
                                            <div class="cc-number">
                                                {% if selected_wallet %}
                                                    {% with cards=selected_wallet.user.card_set.all %}
                                                    {% if cards and cards|length>0 %}
                                                        {% for c in cards|slice:":1" %}
                                                            {% comment %} show masked card number {% endcomment %}
                                                            <h6>{{ c.card_number|slice:":4" }}</h6>
                                                            <h6>{{ c.card_number|slice:"4:8" }}</h6>
                                                            <h6>{{ c.card_number|slice:"8:12" }}</h6>
                                                            <h6>{{ c.card_number|slice:"-4:" }}</h6>
                                                        {% endfor %}
                                                    {% else %}
                                                        <h6>****</h6><h6>****</h6><h6>****</h6><h6>****</h6>
                                                    {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    <h6>****</h6><h6>****</h6><h6>****</h6><h6>****</h6>
                                                {% endif %}
                                            </div>
                                            <div class="cc-holder-exp">
                                                <h5>{{ request.user.get_full_name }}</h5>
                                                <div class="exp"><span>EXP:</span><strong>--/--</strong></div>
                                            </div>
                                            <div class="cc-info">
                                                <div class="row justify-content-between align-items-center">
                                                    <div class="col-5">
                                                        <div class="d-flex">
                                                            <p class="me-3">Status</p>
                                                            <p><strong>Active</strong></p>
                                                        </div>
                                                        <div class="d-flex">
                                                            <p class="me-3">Currency</p>
                                                            <p><strong>USD</strong></p>
                                                        </div>
                                                    </div>
                                                    <div class="col-xl-7">
                                                        <div class="d-flex justify-content-between">
                                                            <div class="ms-3">
                                                                <p>Credit Limit</p>
                                                                <p><strong>-- USD</strong></p>
                                                            </div>
                                                            <div id="circle3"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                                        <div class="stat-widget-1">
                                            <h6>Total Balance</h6>
                                            <h3>${{ total_balance }}</h3>
                                            <p>
                                                <span class="text-success"><i class="fi fi-rr-arrow-trend-up"></i>2.47%</span>
                                                Last month <strong>${{ total_balance|floatformat:0 }}</strong>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                                        <div class="stat-widget-1">
                                            <h6>Monthly Expenses</h6>
                                            <h3>${{ monthly_expenses }}</h3>
                                            <p>
                                                <span class="text-success"><i class="fi fi-rr-arrow-trend-up"></i>2.47%</span>
                                                Last month <strong>${{ monthly_expenses|floatformat:0 }}</strong>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-xxl-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="card-title">Balance Overtime</h4>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="chartjsBalanceOvertime"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="card-title">Transaction History</h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="transaction-table">
                                                    <div class="table-responsive">
                                                        <table class="table mb-0 table-responsive-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Category</th>
                                                                    <th>Date</th>
                                                                    <th>Description</th>
                                                                    <th>Amount</th>
                                                                    <th>Currency</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for t in transactions %}
                                                                <tr>
                                                                    <td>
                                                                        <span class="table-category-icon">{{ t.category }}</span>
                                                                    </td>
                                                                    <td>{{ t.date|date:"d.m.Y" }}</td>
                                                                    <td>{{ t.description }}</td>
                                                                    <td>{% if t.type=='expense' %}-{% endif %}{{ t.amount }}</td>
                                                                    <td>USD</td>
                                                                </tr>
                                                                {% empty %}
                                                                <tr><td colspan="5">No transactions yet.</td></tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}